digraph PeggedOrder {
  rankdir = LR;
  node [shape = circle];

  S0 [color = green, fontcolor = green];
  S2 [color = red, fontcolor = red];
  S4 [color = blue, fontcolor = blue];

  S0 -> S1 [label = "E0"];
  S1 -> S2 [label = "E1"];
  S1 -> S3 [label = "E2"];
  S3 -> S3 [label = "E0"];
  S3 -> S4 [label = "E3"];
  S3 -> S5 [label = "C0"];
  S5 -> S4 [label = "E3"];
  S5 -> S1 [label = "E4"];
}

Parameters
  order_fields: OrderFields
  offset: Money

Variables
  position: Quantity

States
  S0: query_bbo_quotes(order_fields.security) as bbo_quote

  S1:
    price = pick(order_fields.side, bbo_quote.ask.price, bbo_quote.bid.price) - get_direction(order_fields.side) * offset
    submit_order(order_fields.security, price, order_fields.quantity - position) as order

  S5: cancel(order)

Events:
  E0: BboQuote(bbo_quote)
  E1: ExecutionReport(order) e where e.status == REJECTED
  E2: ExecutionReport(order) e where e.status == NEW
  E3: ExecutionReport(order) e where e.status == FILLED
  E4: ExecutionReport(order) e where is_terminal(e.status)

Conditions:
  C0:
    price = pick(order_fields.side, bbo_quote.ask.price, bbo_quote.bid.price) - get_direction(order_fields.side) * offset
    order.info.price != price

Handlers:
  H0:
    ExecutionReport(order) e
    position += e.last_quantity
